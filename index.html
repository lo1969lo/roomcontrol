<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RoomControl (temps réel)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    body {
      font-family: Arial;
      padding: 2rem;
      transition: background 0.3s, color 0.3s;
    }
    body.dark { background: #121212; color: #f5f5f5; }
    body.light { background: #fff; color: #000; }
    .theme-toggle {
      position: fixed; top: 1rem; right: 1rem;
      background: none; border: none;
      font-size: 1.5rem; cursor: pointer; z-index: 1000;
    }
    .legend {
      margin: 1rem 0; display: flex; flex-wrap: nowrap;
      gap: 8px; align-items: center; justify-content: flex-start; overflow-x: auto;
    }
    .etat-item {
      padding: 5px 10px; border-radius: 5px;
      font-size: 0.75rem; color: white; min-width: 75px; white-space: nowrap;
    }
    .etat-collabo {
      font-size: 0.85rem; margin-top: 0.5rem;
    }
    .etage { margin-bottom: 2rem; page-break-after: always; }
    .chambres { display: flex; flex-wrap: wrap; gap: 10px; }
    .chambre {
      background: #1e1e1e; padding: 1rem; border-radius: 8px;
      min-width: 100px; text-align: center; transition: box-shadow 0.3s ease;
    }
    .highlight { box-shadow: 0 0 15px 3px #00ff00; }
    #resume { margin-top: 2rem; padding: 1rem; background: #222;
      color: #f5f5f5; border-radius: 8px; box-shadow: 0 0 5px rgba(255,255,255,0.1); }
    #resume h2 { margin-bottom: 1rem; }
    #muteToggle { float: right; background: none; border: none; font-size: 1.2rem; cursor: pointer; color: #fff; }
    select, button { margin: 0.3rem 0; width: 100%; height: 2rem; }
  </style>
</head>
<body class="dark">
  <button class="theme-toggle" onclick="toggleTheme()">🌙</button>
  <audio id="notifSound" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg" preload="auto"></audio>

  <label for="filtre">Filtrer par :</label>
  <select id="filtre" onchange="filtrer()">
    <option value="all">Tous</option>
    <option value="etage1">Étage 1</option>
    <option value="etage2">Étage 2</option>
    <option value="alice">Alice</option>
    <option value="bob">Bob</option>
  </select>

  <div class="legend">
    <div class="etat-item" style="background:red">Départ</div>
    <div class="etat-item" style="background:navy">Recouche</div>
    <div class="etat-item" style="background:yellow;color:black">Prête</div>
  </div>

  <div class="chambres">
    <div class="chambre" data-id="101" data-etage="etage1" data-collaborateur="alice">
      <div>Chambre 101</div>
      <div class="etat-collabo">PRÊTE</div>
      <button onclick="changerEtat(this, 'depart')">Départ</button>
      <button onclick="changerEtat(this, 'recouche')">Recouche</button>
    </div>
    <div class="chambre" data-id="102" data-etage="etage2" data-collaborateur="bob">
      <div>Chambre 102</div>
      <div class="etat-collabo">PRÊTE</div>
      <button onclick="changerEtat(this, 'depart')">Départ</button>
      <button onclick="changerEtat(this, 'recouche')">Recouche</button>
    </div>
  </div>

  <script>
    function toggleTheme() {
      const body = document.body;
      const next = body.classList.contains("dark") ? "light" : "dark";
      body.className = next;
      document.querySelector(".theme-toggle").textContent = next === "dark" ? "🌙" : "☀️";
      localStorage.setItem("theme", next);
    }
    window.onload = () => {
      const saved = localStorage.getItem("theme") || "dark";
      document.body.className = saved;
      document.querySelector(".theme-toggle").textContent = saved === "dark" ? "🌙" : "☀️";
      planifierEnvoiPDF();
    };

    function changerEtat(button, nouvelEtat) {
      const chambre = button.closest(".chambre");
      chambre.querySelector(".etat-collabo").textContent = nouvelEtat.toUpperCase();
      chambre.classList.add("highlight");
      setTimeout(() => chambre.classList.remove("highlight"), 1000);
    }

    function filtrer() {
      const filtre = document.getElementById("filtre").value;
      document.querySelectorAll(".chambre").forEach(el => {
        const match = filtre === "all" ||
          el.dataset.etage === filtre ||
          el.dataset.collaborateur === filtre;
        el.style.display = match ? '' : 'none';
      });
    }

    function generateAndSendPDF() {
      const element = document.body;
      const opt = {
        margin: 0.5,
        filename: `rapport_${new Date().toISOString().split('T')[0]}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
      };
      html2pdf().from(element).set(opt).outputPdf('blob').then(blob => {
        const formData = new FormData();
        formData.append('pdf', blob, opt.filename);
        fetch('https://ton-backend/send-pdf', {
          method: 'POST',
          body: formData
        }).then(r => console.log('PDF envoyé')).catch(err => console.error('Erreur envoi', err));
      });
    }

    function planifierEnvoiPDF() {
      const now = new Date();
      const target = new Date();
      target.setHours(23, 59, 0, 0);
      if (now > target) target.setDate(target.getDate() + 1);
      const delay = target - now;
      setTimeout(() => {
        generateAndSendPDF();
        setInterval(generateAndSendPDF, 24 * 60 * 60 * 1000);
      }, delay);
    }
  </script>
</body>
</html>
